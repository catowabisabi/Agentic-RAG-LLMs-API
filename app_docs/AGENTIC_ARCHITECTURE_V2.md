# Agentic AI Architecture V2 - è¨­è¨ˆæ–‡æª”

> ä½œè€…ï¼šå•†æ¥­è»Ÿä»¶è¨­è¨ˆå¸«
> æ—¥æœŸï¼š2026-02-06
> ç‹€æ…‹ï¼šè¨­è¨ˆéšæ®µ

---

## ğŸ“‹ éœ€æ±‚åˆ†æ

æ ¹æ“šæŒ‡å°è€…çš„è¦æ±‚ï¼Œç³»çµ±éœ€è¦å¯¦ç¾ï¼š

### æ ¸å¿ƒéœ€æ±‚

1. **ç„¡é™åé¥‹å¾ªç’°** - Manager æŒçºŒå·¥ä½œç›´åˆ°å¾—åˆ°æ­£ç¢ºç­”æ¡ˆ
2. **LLM æ±ºç­–é©…å‹•** - æ‰€æœ‰ Agent ä½¿ç”¨ asyncï¼Œç§»é™¤ fallbackï¼Œè®“éŒ¯èª¤æš´éœ²
3. **Skills / Tools / MCP æ•´åˆ** - å¯æ“´å±•çš„èƒ½åŠ›ç³»çµ±
4. **ä»»å‹™ç‹€æ…‹è¿½è¹¤** - TODO Tasks æœ‰ç‹€æ…‹ï¼ŒManager è¨˜éŒ„ä¸¦åˆ†ç™¼
5. **å³æ™‚å›é¥‹** - å®Œæˆç‰¹å®šä»»å‹™å¾Œæ¨é€çµ¦ç”¨æˆ¶ï¼Œä½†ç¹¼çºŒå·¥ä½œ
6. **æœ€çµ‚ç¸½çµ** - æ‰€æœ‰ä»»å‹™æˆåŠŸæˆ–é‡è©¦ 5 æ¬¡å¾Œçµ¦å‡ºç¸½çµ
7. **å®Œæ•´å°è©±ä¿ç•™** - å°è©±å’Œæ€è€ƒéç¨‹éƒ½ä¿ç•™

---

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### é«˜å±¤è¦–åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER INTERFACE (WebSocket)                      â”‚
â”‚                      å¯¦æ™‚é¡¯ç¤ºæ€è€ƒéç¨‹ / ä»»å‹™ç‹€æ…‹ / ä¸­é–“çµæœ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ â–²
                                    â–¼ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           UNIFIED EVENT MANAGER                          â”‚
â”‚             æ‰€æœ‰äº‹ä»¶é€šéé€™è£¡å»£æ’­ï¼šthinking_step / task_update / result   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ â–²
                                    â–¼ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MANAGER AGENT (ä¸­å¤®å”èª¿å™¨)                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Goal Detector  â”‚  â”‚   Task Queue     â”‚  â”‚   Loop Engine    â”‚      â”‚
â”‚  â”‚   (ç™¼ç¾ç›®æ¨™)      â”‚  â”‚   (ä»»å‹™éšŠåˆ—)      â”‚  â”‚   (ç„¡é™å¾ªç’°)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Aggregator     â”‚  â”‚   Retry Manager  â”‚  â”‚   Summarizer     â”‚      â”‚
â”‚  â”‚   (æ•¸æ“šèšåˆ)      â”‚  â”‚   (é‡è©¦ç®¡ç†)      â”‚  â”‚   (æœ€çµ‚ç¸½çµ)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PLANNING AGENT    â”‚ â”‚    RAG AGENT        â”‚ â”‚   THINKING AGENT    â”‚
â”‚   ç”¢ç”Ÿ TODO Tasks   â”‚ â”‚   çŸ¥è­˜æª¢ç´¢          â”‚ â”‚   æ·±åº¦æ¨ç†          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                   â”‚                   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CAPABILITY LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Skills     â”‚  â”‚   Tools      â”‚  â”‚   MCP        â”‚  â”‚   Memory   â”‚ â”‚
â”‚  â”‚   (æŠ€èƒ½åº«)    â”‚  â”‚   (å·¥å…·åº«)    â”‚  â”‚   (å”è­°æ“´å±•)  â”‚  â”‚   (è¨˜æ†¶)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ç„¡é™åé¥‹å¾ªç’° (Infinite Feedback Loop)

### ç‹€æ…‹æ©Ÿå®šç¾©

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                                      â”‚
                     â–¼                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
â”‚  IDLE    â”‚â”€â”€â”€â–¶â”‚  GOAL    â”‚â”€â”€â”€â–¶â”‚ PLANNING â”‚â”€â”€â”€â–¶â”‚  EXECUTING  â”‚
â”‚  ç­‰å¾…è¼¸å…¥ â”‚    â”‚  DETECT  â”‚    â”‚  ç”¢ç”Ÿä»»å‹™ â”‚    â”‚  åŸ·è¡Œä»»å‹™    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                     â”‚                                  â”‚
                     â–¼                                  â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  AGGREGATING â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   WAITING    â”‚
              â”‚  æ”¶é›†çµæœ     â”‚                  â”‚   ç­‰å¾…å­ä»»å‹™  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                      â”‚
         â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ALL COMPLETE â”‚        â”‚  HAS FAILED  â”‚
â”‚  å…¨éƒ¨æˆåŠŸ     â”‚        â”‚  æœ‰å¤±æ•—ä»»å‹™   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â”‚                      â”‚ retry < 5?
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â–¼               â–¼
         â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚        â”‚  RETRY   â”‚    â”‚ GIVE UP  â”‚
         â”‚        â”‚  é‡è©¦     â”‚    â”‚  æ”¾æ£„    â”‚
         â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚               â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         SUMMARIZING          â”‚
    â”‚         ç”Ÿæˆæœ€çµ‚ç¸½çµ          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           DONE               â”‚
    â”‚     æ¨é€çµæœçµ¦ç”¨æˆ¶            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä»»å‹™æ¨¡å‹ (Task Model)

### TodoTask å®šç¾©

```python
class TodoTask(BaseModel):
    """å–®ä¸€ä»»å‹™å®šç¾©"""
    id: str                           # å”¯ä¸€ ID
    title: str                        # ä»»å‹™æ¨™é¡Œ
    description: str                  # è©³ç´°æè¿°
    
    # ç‹€æ…‹
    status: TaskStatus                # not_started | in_progress | completed | failed | cancelled
    
    # åŸ·è¡Œä¿¡æ¯
    assigned_agent: Optional[str]     # åˆ†é…çµ¦å“ªå€‹ Agent
    depends_on: List[str]             # ä¾è³´çš„ä»»å‹™ ID
    retry_count: int = 0              # é‡è©¦æ¬¡æ•¸
    max_retries: int = 5              # æœ€å¤§é‡è©¦
    
    # çµæœ
    result: Optional[Dict[str, Any]]  # åŸ·è¡Œçµæœ
    error: Optional[str]              # éŒ¯èª¤ä¿¡æ¯
    
    # æ™‚é–“æˆ³
    created_at: datetime
    started_at: Optional[datetime]
    completed_at: Optional[datetime]


class TaskStatus(str, Enum):
    NOT_STARTED = "not_started"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"
```

### TaskQueue å®šç¾©

```python
class TaskQueue:
    """Manager çš„ä»»å‹™éšŠåˆ—"""
    
    goal: str                         # æœ€çµ‚ç›®æ¨™
    tasks: Dict[str, TodoTask]        # æ‰€æœ‰ä»»å‹™
    execution_order: List[str]        # åŸ·è¡Œé †åº
    
    def get_ready_tasks(self) -> List[TodoTask]:
        """ç²å–å¯ä»¥é–‹å§‹çš„ä»»å‹™ï¼ˆä¾è³´å·²æ»¿è¶³ï¼‰"""
        
    def get_in_progress(self) -> List[TodoTask]:
        """ç²å–æ­£åœ¨åŸ·è¡Œçš„ä»»å‹™"""
        
    def get_completed(self) -> List[TodoTask]:
        """ç²å–å·²å®Œæˆçš„ä»»å‹™"""
        
    def has_all_completed(self) -> bool:
        """æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ"""
        
    def has_failed_tasks(self) -> bool:
        """æª¢æŸ¥æ˜¯å¦æœ‰å¤±æ•—ä»»å‹™"""
```

---

## ğŸ”— Manager Agent æ ¸å¿ƒé‚è¼¯

### ä¸»å¾ªç’°å½ä»£ç¢¼

```python
async def run_agentic_loop(self, user_query: str, session_id: str):
    """
    ç„¡é™åé¥‹å¾ªç’°çš„æ ¸å¿ƒé‚è¼¯
    
    é€™æ˜¯ Agentic AI çš„å¿ƒè‡Ÿï¼š
    1. ç™¼ç¾ç›®æ¨™
    2. ç”¢ç”Ÿè¨ˆåŠƒ
    3. åŸ·è¡Œä»»å‹™
    4. æ”¶é›†çµæœ
    5. å¾ªç’°ç›´åˆ°å®Œæˆæˆ–å¤±æ•—
    """
    
    # === Phase 1: Goal Detection ===
    goal = await self._detect_goal(user_query)
    await self._emit_thinking_step("goal_detected", goal)
    
    # === Phase 2: Planning ===
    task_queue = await self._generate_plan(goal)
    await self._emit_thinking_step("plan_created", task_queue.summary())
    
    # === Phase 3: Execution Loop ===
    while not task_queue.is_terminal_state():
        
        # 3.1 ç²å–å¯åŸ·è¡Œçš„ä»»å‹™
        ready_tasks = task_queue.get_ready_tasks()
        
        if not ready_tasks:
            # ç­‰å¾…æ­£åœ¨åŸ·è¡Œçš„ä»»å‹™å®Œæˆ
            await self._wait_for_completions()
            continue
        
        # 3.2 ä¸¦è¡Œåˆ†ç™¼ä»»å‹™çµ¦ Agents
        futures = []
        for task in ready_tasks:
            task.status = TaskStatus.IN_PROGRESS
            await self._emit_task_update(task)
            
            future = self._dispatch_to_agent(task)
            futures.append(future)
        
        # 3.3 ç­‰å¾…çµæœï¼ˆä½†ä¸é˜»å¡å…¶ä»–ä»»å‹™ï¼‰
        # ä½¿ç”¨ asyncio.as_completed å¯¦ç¾ã€Œæœ‰çµæœå°±è™•ç†ã€
        for coro in asyncio.as_completed(futures):
            task_id, result = await coro
            
            task = task_queue.tasks[task_id]
            
            if result.success:
                task.status = TaskStatus.COMPLETED
                task.result = result.data
                
                # === é‡è¦ï¼šå³æ™‚æ¨é€ä¸­é–“çµæœçµ¦ç”¨æˆ¶ ===
                await self._emit_intermediate_result(task)
                
            else:
                task.retry_count += 1
                if task.retry_count < task.max_retries:
                    task.status = TaskStatus.NOT_STARTED  # é‡æ–°æ’éšŠ
                    await self._emit_thinking_step(
                        "task_retry", 
                        f"ä»»å‹™ {task.title} å¤±æ•—ï¼Œé‡è©¦ {task.retry_count}/5"
                    )
                else:
                    task.status = TaskStatus.FAILED
                    task.error = result.error
            
            await self._emit_task_update(task)
    
    # === Phase 4: Aggregation ===
    all_results = [t.result for t in task_queue.get_completed()]
    
    # === Phase 5: Final Summary ===
    summary = await self._generate_summary(goal, task_queue, all_results)
    
    await self._emit_final_response(summary)
    
    return summary
```

---

## ğŸ“¡ WebSocket äº‹ä»¶æµ

### äº‹ä»¶é¡å‹

```typescript
// å‰ç«¯æ¥æ”¶çš„äº‹ä»¶é¡å‹
type EventType = 
    | 'thinking_step'      // æ€è€ƒæ­¥é©Ÿ
    | 'task_created'       // ä»»å‹™å‰µå»º
    | 'task_updated'       // ä»»å‹™ç‹€æ…‹æ›´æ–°
    | 'intermediate_result' // ä¸­é–“çµæœï¼ˆå¯ä»¥å±•ç¤ºçµ¦ç”¨æˆ¶ï¼‰
    | 'final_response'     // æœ€çµ‚å›æ‡‰
    | 'error'              // éŒ¯èª¤
```

### äº‹ä»¶çµæ§‹

```json
{
    "type": "task_updated",
    "session_id": "xxx",
    "timestamp": "2026-02-06T12:00:00Z",
    "data": {
        "task_id": "task_001",
        "title": "æœç´¢çŸ¥è­˜åº«",
        "status": "completed",
        "result": { ... },
        "can_show_to_user": true
    }
}
```

---

## ğŸ› ï¸ Capability Layer è¨­è¨ˆ

### Skills (æŠ€èƒ½)

å¾ `.claude/skills/` è¼‰å…¥çš„æŠ€èƒ½åŒ…ï¼š

```python
class Skill(BaseModel):
    name: str
    description: str
    file_path: str
    
    async def execute(self, input: Dict) -> Dict:
        """åŸ·è¡ŒæŠ€èƒ½"""
```

### Tools (å·¥å…·)

å…§å»ºå’Œå¤–éƒ¨å·¥å…·ï¼š

```python
class Tool(BaseModel):
    name: str
    description: str
    parameters: Dict[str, Any]  # JSON Schema
    
    async def call(self, **kwargs) -> Any:
        """èª¿ç”¨å·¥å…·"""
```

### MCP (Model Context Protocol)

æ“´å±•èƒ½åŠ›ï¼š

```python
class MCPProvider:
    """MCP æœå‹™æä¾›è€…"""
    
    async def list_tools(self) -> List[Tool]:
        """åˆ—å‡ºå¯ç”¨å·¥å…·"""
    
    async def call_tool(self, name: str, args: Dict) -> Any:
        """èª¿ç”¨ MCP å·¥å…·"""
```

---

## ğŸ—ƒï¸ æ•¸æ“šä¿ç•™

### å°è©±ä¿ç•™

```python
class ConversationStore:
    """ä¿ç•™å®Œæ•´å°è©±æ­·å²"""
    
    messages: List[Message]        # ç”¨æˆ¶å’ŒåŠ©æ‰‹æ¶ˆæ¯
    thinking_steps: List[Step]     # æ‰€æœ‰æ€è€ƒæ­¥é©Ÿ
    task_history: List[TaskLog]    # ä»»å‹™åŸ·è¡Œæ­·å²
    
    def get_context_for_llm(self) -> str:
        """ç”Ÿæˆ LLM å¯ç”¨çš„ä¸Šä¸‹æ–‡"""
```

### Session éš”é›¢

```python
class SessionManager:
    """ç¢ºä¿ Session å®Œå…¨éš”é›¢"""
    
    def get_session(self, session_id: str) -> Session:
        """ç²å–æˆ–å‰µå»º Session"""
    
    def cleanup_session(self, session_id: str):
        """æ¸…ç† Session æ•¸æ“š"""
```

---

## ğŸš¨ éŒ¯èª¤è™•ç†ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰

### è¨­è¨ˆåŸå‰‡

**ç§»é™¤æ‰€æœ‰ fallbackï¼Œè®“éŒ¯èª¤æš´éœ²ï¼š**

```python
# âŒ ä¹‹å‰çš„è¨­è¨ˆï¼ˆåæ‰éŒ¯èª¤ï¼‰
async def match(self, message: str) -> IntentMatch:
    try:
        result = await self._llm_classify(message)
        return result
    except Exception as e:
        logger.warning(f"LLM failed: {e}")
        return IntentMatch(intent="general_query")  # éœé»˜ fallback

# âœ… æ–°è¨­è¨ˆï¼ˆè®“éŒ¯èª¤æš´éœ²ï¼‰
async def match(self, message: str) -> IntentMatch:
    # NOTE: Testing mode - no fallback, errors will propagate
    # TODO: Add proper fallback for production
    result = await self._llm_classify(message)
    return result
```

### éŒ¯èª¤å‚³æ’­

```python
class AgentError(Exception):
    """Agent åŸ·è¡ŒéŒ¯èª¤"""
    agent_name: str
    task_id: str
    original_error: Exception
    
# éŒ¯èª¤æœƒå‚³æ’­åˆ° Managerï¼Œç”± Manager æ±ºå®šé‡è©¦æˆ–æ”¾æ£„
```

---

## ğŸ“Š ç¾æœ‰ä»£ç¢¼ä¿ç•™æ¸…å–®

### å¿…é ˆä¿ç•™çš„æ ¸å¿ƒé‚è¼¯

| æ–‡ä»¶ | ä¿ç•™å…§å®¹ | åŸå›  |
|------|----------|------|
| `planning_agent.py` | LangGraph çµæ§‹ | å®Œæ•´çš„ Generate â†’ Validate â†’ Refine è¿´åœˆ |
| `react_loop.py` | ReAct + PEV | æ€è€ƒ â†’ è¡Œå‹• â†’ è§€å¯Ÿ â†’ é©—è­‰ è¿´åœˆ |
| `agentic_orchestrator.py` | Metacognition é‚è¼¯ | è‡ªæˆ‘è©•ä¼°å’Œç­–ç•¥é¸æ“‡ |
| `manager_agent.py` | Agent Registry æ•´åˆ | Agent è¨»å†Šå’Œèª¿åº¦ |
| `task_manager.py` | TaskResult æ¨¡å‹ | ä»»å‹™ç‹€æ…‹è¿½è¹¤ |
| `unified_event_manager.py` | WebSocket å»£æ’­ | å¯¦æ™‚äº‹ä»¶æ¨é€ |
| `session_db.py` | Session å­˜å„² | å°è©±å’Œæ€è€ƒä¿ç•™ |

### éœ€è¦é‡æ§‹çš„éƒ¨åˆ†

| æ–‡ä»¶ | æ”¹å‹• | åŸå›  |
|------|------|------|
| `intent_router.py` | ç§»é™¤ fallback | æ¸¬è©¦æ¨¡å¼éœ€è¦éŒ¯èª¤æš´éœ² |
| `entry_classifier.py` | ç´” async | ç¢ºä¿æ­£ç¢ºçš„ async æµç¨‹ |
| `manager_agent.py` | æ·»åŠ  TaskQueue | æ”¯æŒç„¡é™å¾ªç’° |
| `chat_service.py` | æ•´åˆæ–° Loop | é€£æ¥ UI å’Œ Manager |

---

## ğŸ”œ å¯¦æ–½é€²åº¦

### âœ… Phase 1: ç§»é™¤æ‰€æœ‰ fallbackï¼ˆå·²å®Œæˆï¼‰

ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `agents/shared_services/intent_router.py` - ç§»é™¤ fallbackï¼ŒéŒ¯èª¤ç›´æ¥å‚³æ’­
- `agents/core/casual_chat_agent.py` - ç§»é™¤ try-catchï¼ŒLLM æ±ºç­–

### âœ… Phase 2: å¯¦ç¾ TaskQueue æ¨¡å‹ï¼ˆå·²å®Œæˆï¼‰

æ–°æ–‡ä»¶ï¼š
- `agents/core/agentic_task_queue.py`
  - `TodoTask` - å–®ä¸€ä»»å‹™æ¨¡å‹
  - `TodoStatus` - ä»»å‹™ç‹€æ…‹æšèˆ‰
  - `TaskQueue` - ä»»å‹™éšŠåˆ—ç®¡ç†
  - `AgenticLoopContext` - å¾ªç’°ä¸Šä¸‹æ–‡
  - `AgenticLoopState` - å¾ªç’°ç‹€æ…‹

### âœ… Phase 3: Agentic Loop Engineï¼ˆå·²å®Œæˆï¼‰

æ–°æ–‡ä»¶ï¼š
- `agents/core/agentic_loop_engine.py`
  - `AgenticLoopEngine` - æ ¸å¿ƒå¼•æ“
  - `detect_goal()` - ç›®æ¨™ç™¼ç¾
  - `generate_plan()` - ä»»å‹™è¦åŠƒ
  - `execute_loop()` - åŸ·è¡Œå¾ªç’°
  - `generate_summary()` - æœ€çµ‚ç¸½çµ

### âœ… Phase 4: æ•´åˆ WebSocket äº‹ä»¶æµï¼ˆå·²å®Œæˆï¼‰

ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `services/chat_service.py`
  - æ·»åŠ  `_get_agentic_loop()` æ–¹æ³• - å‰µå»ºä¸¦é€£æ¥å›èª¿
  - æ·»åŠ  `process_message_agentic()` æ–¹æ³• - æ–°è™•ç†æµç¨‹
  - å›èª¿é€£æ¥åˆ° `UnifiedEventManager` çš„ `emit_*` æ–¹æ³•

- `fast_api/routers/chat_router.py`
  - æ·»åŠ  `POST /chat/agentic` ç«¯é» - æ¸¬è©¦æ–°æµç¨‹
  - `AgenticChatRequest` / `AgenticChatResponse` æ¨¡å‹

### ğŸ”„ Phase 5: æ¸¬è©¦å’Œé©—è­‰ï¼ˆå¾…å®Œæˆï¼‰

æ¸¬è©¦å‘½ä»¤ï¼š
```bash
# å•Ÿå‹•æœå‹™
start_local.bat

# æ¸¬è©¦ Agentic ç«¯é»
curl -X POST http://localhost:1130/chat/agentic \
  -H "Content-Type: application/json" \
  -d '{"message": "What is VBA?"}'
```

---

## ğŸ“ æ–‡ä»¶è®Šæ›´æ¸…å–®

| æ–‡ä»¶ | æ“ä½œ | æè¿° |
|------|------|------|
| `agents/core/agentic_task_queue.py` | æ–°å¢ | TaskQueue + TodoTask æ¨¡å‹ |
| `agents/core/agentic_loop_engine.py` | æ–°å¢ | ç„¡é™åé¥‹å¾ªç’°å¼•æ“ |
| `agents/shared_services/intent_router.py` | ä¿®æ”¹ | ç§»é™¤ fallback |
| `agents/core/casual_chat_agent.py` | ä¿®æ”¹ | ç§»é™¤ fallback |
| `services/chat_service.py` | ä¿®æ”¹ | æ·»åŠ  Agentic è™•ç†æ–¹æ³• |
| `fast_api/routers/chat_router.py` | ä¿®æ”¹ | æ·»åŠ  /chat/agentic ç«¯é» |

---

## â“ å¾…ç¢ºèªå•é¡Œ

1. ä¸­é–“çµæœæ¨é€çš„é »ç‡ï¼Ÿï¼ˆæ¯å®Œæˆä¸€å€‹ä»»å‹™ vs å®šæ™‚æ‰¹é‡ï¼‰
2. æœ€å¤§ä¸¦è¡Œä»»å‹™æ•¸ï¼Ÿï¼ˆé¿å… LLM éè¼‰ï¼‰
3. Session è¶…æ™‚æ™‚é–“ï¼Ÿï¼ˆå¤šä¹…æ²’æ´»å‹•è‡ªå‹•æ¸…ç†ï¼‰
4. å¤±æ•—ä»»å‹™çš„é‡è©¦é–“éš”ï¼Ÿï¼ˆç«‹å³ vs æŒ‡æ•¸é€€é¿ï¼‰

---

> é€™æ˜¯è¨­è¨ˆæ–‡æª”ï¼Œå¯¦éš›ä»£ç¢¼æ”¹å‹•å°‡åœ¨ç¢ºèªè¨­è¨ˆå¾Œé€²è¡Œã€‚
