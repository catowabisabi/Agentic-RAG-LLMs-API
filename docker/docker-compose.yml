version: '3.8'

services:
  # Main API Server
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: agentic-rag-api
    ports:
      - "1130:1130"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4o-mini}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      - MAX_TOKENS=${MAX_TOKENS:-2000}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - CHROMA_DB_PATH=/app/data/vectordb
      - MEMORY_DB_PATH=/app/data/memory
      - API_HOST=0.0.0.0
      - API_PORT=1130
      - MCP_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - REDIS_ENABLED=true
      - REDIS_URL=redis://redis:6379/0
      - CELERY_ENABLED=true
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    volumes:
      - ../rag-database:/app/data
      - ../documents:/app/documents
    networks:
      - agentic-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1130/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Demo UI (Next.js)
  ui:
    build:
      context: ../ui
      dockerfile: Dockerfile
    container_name: agentic-rag-ui
    ports:
      - "1131:1131"
    environment:
      - NEXT_PUBLIC_API_URL=http://api:1130
    depends_on:
      - api
    networks:
      - agentic-network
    restart: unless-stopped

  # MCP Server (optional, for external MCP clients)
  mcp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mcp
    container_name: agentic-rag-mcp
    ports:
      - "8001:8001"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4o-mini}
      - CHROMA_DB_PATH=/app/data/vectordb
    volumes:
      - ../rag-database:/app/data
    networks:
      - agentic-network
    depends_on:
      - api
    restart: unless-stopped

  # ChromaDB (optional standalone)
  chromadb:
    image: chromadb/chroma:latest
    container_name: agentic-rag-chromadb
    ports:
      - "8002:8000"
    volumes:
      - chroma-data:/chroma/chroma
    networks:
      - agentic-network
    restart: unless-stopped
    profiles:
      - standalone-db

  # Redis (session storage & Celery broker)
  redis:
    image: redis:alpine
    container_name: agentic-rag-redis
    ports:
      - \"6379:6379\"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - agentic-network
    restart: unless-stopped
    healthcheck:
      test: [\"CMD\", \"redis-cli\", \"ping\"]
      interval: 10s
      timeout: 5s
      retries: 3
  # Celery Worker (distributed task processing)
  celery-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: agentic-rag-celery-worker
    command: celery -A services.celery_service:celery_app worker --loglevel=info --concurrency=2
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4o-mini}
      - CELERY_ENABLED=true
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - REDIS_ENABLED=true
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_DB_PATH=/app/data/vectordb
      - MEMORY_DB_PATH=/app/data/memory
    volumes:
      - ../rag-database:/app/data
    networks:
      - agentic-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - production
networks:
  agentic-network:
    driver: bridge

volumes:
  chroma-data:
  redis-data: